# å‚æ•°æ ¡éªŒ

## ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

## ä¸¾ä¾‹

```java
package com.base.pre.controller;

import cn.dev33.satoken.util.SaResult;
import cn.dev33.satoken.exception.NotLoginException;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotNull;
import org.springframework.web.bind.annotation.*;


/**
 * <p>
 *   Demo æ§åˆ¶å™¨ï¼Œç”¨äºè§¦å‘å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 * </p>
 *
 * @author
 */
@RestController
@RequestMapping("/demo2")
@Tag(name = "å¼‚å¸¸æ¼”ç¤ºæ¥å£")
public class DemoController {

    @GetMapping("/npe")
    @Operation(summary = "è§¦å‘ç©ºæŒ‡é’ˆå¼‚å¸¸")
    public SaResult npe() {
        String str = null;
        str.length(); // NullPointerException
        return SaResult.ok();
    }

    @GetMapping("/illegal")
    @Operation(summary = "è§¦å‘éæ³•å‚æ•°å¼‚å¸¸")
    public SaResult illegal() {
        throw new IllegalArgumentException("å‚æ•°å€¼ä¸åˆæ³•ï¼");
    }

    @PostMapping("/duplicate")
    @Operation(summary = "è§¦å‘æ•°æ®åº“å”¯ä¸€çº¦æŸå¼‚å¸¸")
    public SaResult duplicate() {
        throw new org.springframework.dao.DataIntegrityViolationException("å”¯ä¸€çº¦æŸå†²çª");
    }

    @PostMapping("/valid")
    @Operation(summary = "è§¦å‘ @Valid æ ¡éªŒå¼‚å¸¸ï¼ˆMethodArgumentNotValidExceptionï¼‰")
    public SaResult valid(@Valid @RequestBody UserDTO userDTO) {
        return SaResult.ok("æ ¡éªŒé€šè¿‡: " + userDTO.getName());
    }

    @GetMapping("/param")
    @Operation(summary = "è§¦å‘å‚æ•°æ ¡éªŒå¼‚å¸¸ï¼ˆConstraintViolationExceptionï¼‰")
    public SaResult param(
            @RequestParam(name = "id")
            @NotNull(message = "id ä¸èƒ½ä¸ºç©º")
            @Min(value = 1, message = "id å¿…é¡»å¤§äº 0")
            Integer id) {
        return SaResult.ok("æ”¶åˆ°id=" + id);
    }

    @GetMapping("/needLogin")
    @Operation(summary = "è§¦å‘æœªç™»å½•å¼‚å¸¸ï¼ˆNotLoginExceptionï¼‰")
    public SaResult needLogin() {
        throw new NotLoginException("æœªç™»å½•","/login","è¯·å…ˆç™»å½•");
    }

    // DTO ç”¨äº @Valid æµ‹è¯•
    public static class UserDTO {
        @NotNull(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
        private String name;

        @Min(value = 18, message = "å¹´é¾„å¿…é¡»å¤§äºç­‰äº18")
        private Integer age;

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }
        public Integer getAge() { return age; }
        public void setAge(Integer age) { this.age = age; }
    }
}
```

å…¨å±€å¼‚å¸¸å¤„ç†

```java
package com.base.exception;

import cn.dev33.satoken.exception.NotLoginException;
import cn.dev33.satoken.util.SaResult;
import jakarta.validation.ConstraintViolationException;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.method.annotation.HandlerMethodValidationException;


/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 */
@RestControllerAdvice
public class GlobalExceptionHandler {

    // å…¨å±€å¼‚å¸¸æ‹¦æˆªï¼ˆå…œåº•ï¼‰
    @ExceptionHandler(Exception.class)
    public SaResult handleException(Exception e) {
        e.printStackTrace();
        return SaResult.error("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯: " + e.getMessage());
    }

    // ç©ºæŒ‡é’ˆå¼‚å¸¸
    @ExceptionHandler(NullPointerException.class)
    public SaResult handleNullPointerException(NullPointerException e) {
        e.printStackTrace();
        return SaResult.error("å‡ºç°ç©ºæŒ‡é’ˆï¼Œè¯·æ£€æŸ¥å‚æ•°æˆ–å¯¹è±¡æ˜¯å¦åˆå§‹åŒ–");
    }

    // éæ³•å‚æ•°å¼‚å¸¸
    @ExceptionHandler(IllegalArgumentException.class)
    public SaResult handleIllegalArgumentException(IllegalArgumentException e) {
        e.printStackTrace();
        return SaResult.error("å‚æ•°é”™è¯¯: " + e.getMessage());
    }

    // æ•°æ®å”¯ä¸€æ€§çº¦æŸå¼‚å¸¸ï¼ˆç”¨æˆ·åå·²å­˜åœ¨ç­‰ï¼‰
    @ExceptionHandler(DataIntegrityViolationException.class)
    public SaResult handleDataIntegrityViolationException(DataIntegrityViolationException e) {
        e.printStackTrace();
        return SaResult.error("ç”¨æˆ·åè¢«å ç”¨");
    }

    // ç™»å½•å¼‚å¸¸ï¼ˆæœªç™»å½•ï¼‰
    @ExceptionHandler(NotLoginException.class)
    public SaResult handleNotLoginException(NotLoginException e) {
        e.printStackTrace();
        return SaResult.code(401).setMsg("è¯·å…ˆç™»å½•ï¼Œå†è®¿é—®");
    }

    // æ–¹æ³•å‚æ•°æ ¡éªŒå¼‚å¸¸ï¼ˆ@Valid æ ¡éªŒå¤±è´¥ï¼‰
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public SaResult handleMethodArgumentNotValidException(MethodArgumentNotValidException e) {
        e.printStackTrace();
        String msg = e.getBindingResult().getFieldError().getDefaultMessage();
        return SaResult.error("å‚æ•°æ ¡éªŒå¤±è´¥: " + msg);
    }

    // å•ä¸ªå‚æ•°æ ¡éªŒå¼‚å¸¸ï¼ˆ@NotNullã€@Min ç­‰ç›´æ¥ä½œç”¨åœ¨ Controller å‚æ•°ä¸Šï¼‰
    @ExceptionHandler(ConstraintViolationException.class)
    public SaResult handleConstraintViolationException(ConstraintViolationException e) {
        e.printStackTrace();
        return SaResult.error("å‚æ•°æ ¡éªŒå¤±è´¥: " + e.getMessage());
    }
}
```

## å°ç»“

`spring-boot-starter-validation` = Hibernate Validator + Spring Boot å°è£…ã€‚

æ ¸å¿ƒä½œç”¨ï¼š**å¯¹æ•°æ®åˆæ³•æ€§è¿›è¡Œæ³¨è§£å¼æ ¡éªŒ**ã€‚

ç”¨æ³•ï¼š

- åœ¨ DTO/å®ä½“ç±»ä¸ŠåŠ æ³¨è§£ã€‚
- åœ¨ Controller å‚æ•°ä¸ŠåŠ  `@Valid` æˆ– `@Validated`ã€‚
- è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å¯è¿”å›å‹å¥½æç¤ºã€‚

## å¸¸ç”¨æ ¡éªŒæ³¨è§£é€ŸæŸ¥

### ğŸ”¹ ç©ºå€¼/éç©ºæ ¡éªŒ

- `@NotNull`ï¼šä¸èƒ½ä¸º `null`ï¼ˆä½†å¯ä»¥æ˜¯ç©ºå­—ç¬¦ä¸²ã€é›†åˆç­‰ï¼‰ã€‚
- `@NotBlank`ï¼šä¸èƒ½ä¸º `null`ï¼Œä¸”å­—ç¬¦ä¸²å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªéç©ºæ ¼å­—ç¬¦ã€‚
- `@NotEmpty`ï¼šä¸èƒ½ä¸º `null`ï¼Œå¹¶ä¸”é•¿åº¦å¿…é¡» > 0ï¼ˆé€‚ç”¨äºå­—ç¬¦ä¸²ã€é›†åˆã€æ•°ç»„ï¼‰ã€‚

------

### ğŸ”¹ æ•°å€¼èŒƒå›´

- `@Min(value)`ï¼šæœ€å°å€¼ï¼ˆæ•´æ•°/å°æ•°ï¼‰ã€‚
- `@Max(value)`ï¼šæœ€å¤§å€¼ã€‚
- `@DecimalMin(value)`ï¼šå°æ•°æœ€å°å€¼ï¼ˆæ”¯æŒè¾¹ç•Œå¯æ§ `inclusive=false`ï¼‰ã€‚
- `@DecimalMax(value)`ï¼šå°æ•°æœ€å¤§å€¼ã€‚
- `@Positive`ï¼šå¿…é¡» > 0ã€‚
- `@PositiveOrZero`ï¼šå¿…é¡» â‰¥ 0ã€‚
- `@Negative`ï¼šå¿…é¡» < 0ã€‚
- `@NegativeOrZero`ï¼šå¿…é¡» â‰¤ 0ã€‚
- `@Digits(integer, fraction)`ï¼šæ•°å€¼ä½æ•°çº¦æŸï¼ˆæ•´æ•°éƒ¨åˆ† + å°æ•°éƒ¨åˆ†ï¼‰ã€‚

------

### ğŸ”¹ é•¿åº¦ä¸å¤§å°

- `@Size(min, max)`ï¼šå­—ç¬¦ä¸²ã€æ•°ç»„ã€é›†åˆçš„é•¿åº¦/å¤§å°èŒƒå›´ã€‚
- `@Length(min, max)`ï¼šå­—ç¬¦ä¸²é•¿åº¦é™åˆ¶ï¼ˆHibernate Validator æ‰©å±•ï¼‰ã€‚

------

### ğŸ”¹ å­—ç¬¦ä¸²æ ¼å¼

- `@Email`ï¼šé‚®ç®±æ ¼å¼æ ¡éªŒã€‚
- `@Pattern(regexp)`ï¼šæ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒã€‚
- `@URL`ï¼šURL æ ¼å¼æ ¡éªŒï¼ˆHibernate Validator æ‰©å±•ï¼‰ã€‚

------

### ğŸ”¹ æ—¶é—´æ—¥æœŸ

- `@Future`ï¼šå¿…é¡»æ˜¯å°†æ¥çš„æ—¶é—´ã€‚
- `@FutureOrPresent`ï¼šå¿…é¡»æ˜¯ç°åœ¨æˆ–å°†æ¥ã€‚
- `@Past`ï¼šå¿…é¡»æ˜¯è¿‡å»çš„æ—¶é—´ã€‚
- `@PastOrPresent`ï¼šå¿…é¡»æ˜¯ç°åœ¨æˆ–è¿‡å»ã€‚

------

### ğŸ”¹ ç»„åˆæ ¡éªŒ

- `@Valid`ï¼šçº§è”æ ¡éªŒï¼ˆéªŒè¯åµŒå¥—å¯¹è±¡é‡Œçš„å­—æ®µï¼‰ã€‚
- `@Validated`ï¼šæ”¯æŒ **åˆ†ç»„æ ¡éªŒ**ï¼ˆå¯ä»¥åœ¨ä¸åŒåœºæ™¯ä¸‹åº”ç”¨ä¸åŒçš„æ ¡éªŒè§„åˆ™ï¼‰