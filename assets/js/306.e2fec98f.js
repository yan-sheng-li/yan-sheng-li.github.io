(window.webpackJsonp=window.webpackJsonp||[]).push([[306],{691:function(s,a,t){"use strict";t.r(a);var e=t(0),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"整合webhook自动部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#整合webhook自动部署"}},[s._v("#")]),s._v(" 整合webhook自动部署")]),s._v(" "),a("p",[s._v("在日常开发和部署过程中，我们经常会遇到这样的需求：")]),s._v(" "),a("ul",[a("li",[s._v("希望在本地一键触发远程服务器上的自动构建和部署；")]),s._v(" "),a("li",[s._v("希望能够远程查看服务器关键日志内容，而无需手动登录服务器。")])]),s._v(" "),a("p",[s._v("本文将结合 webhook 工具 "),a("a",{attrs:{href:"https://github.com/adnanh/webhook",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[s._v("webhook")]),a("OutboundLink")],1),s._v("，实现在服务器上接收 HTTP 请求来触发脚本，并返回运行结果。")]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"一、环境说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、环境说明"}},[s._v("#")]),s._v(" 一、环境说明")]),s._v(" "),a("ul",[a("li",[s._v("服务器系统：Linux（Ubuntu / CentOS 均可）")]),s._v(" "),a("li",[s._v("webhook 工具："),a("a",{attrs:{href:"https://github.com/adnanh/webhook",target:"_blank",rel:"noopener noreferrer"}},[s._v("adnanh/webhook"),a("OutboundLink")],1)]),s._v(" "),a("li",[s._v("服务脚本语言：Bash Shell")]),s._v(" "),a("li",[s._v("目标：通过 HTTP 请求远程触发脚本进行服务部署，并查看日志")])]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"二、安装-webhook-工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、安装-webhook-工具"}},[s._v("#")]),s._v(" 二、安装 webhook 工具")]),s._v(" "),a("p",[s._v("首先，在你的服务器上安装 webhook 工具：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载预编译版本（根据系统架构）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/adnanh/webhook/releases/download/2.8.1/webhook-linux-amd64.tar.gz\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-zxvf")]),s._v(" webhook-linux-amd64.tar.gz\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" webhook-linux-amd64/webhook /usr/local/bin/\n")])])]),a("p",[s._v("测试是否安装成功：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("webhook "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-version")]),s._v("\n")])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"三、配置第一个-webhook-一键部署脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、配置第一个-webhook-一键部署脚本"}},[s._v("#")]),s._v(" 三、配置第一个 webhook：一键部署脚本")]),s._v(" "),a("h3",{attrs:{id:"_1-编写部署脚本-one-start-sh"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-编写部署脚本-one-start-sh"}},[s._v("#")]),s._v(" 1. 编写部署脚本 "),a("code",[s._v("one_start.sh")])]),s._v(" "),a("p",[s._v("路径建议放在项目目录下，例如 "),a("code",[s._v("/root/web/project-server/one_start.sh")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"检查更新..."')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" pull\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"清理项目..."')]),s._v("\nmvn clean\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"开始打包..."')]),s._v("\nmvn package\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"项目打包完成！"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("container_name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-server"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("image_name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-server"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除旧容器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--format")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{{.Names}}'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-q")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${container_name}")]),s._v('$"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"发现旧容器，停止并删除中..."')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stop "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$container_name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$container_name")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除旧镜像")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" images "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--format")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{{.Repository}}'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-q")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${image_name}")]),s._v('$"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"发现旧镜像，删除中..."')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" rmi "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$image_name")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建镜像并启动容器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"构建镜像..."')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" build "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$image_name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"启动容器..."')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8082")]),s._v(":8888 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$container_name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--restart")]),s._v(" unless-stopped "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$image_name")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"部署完成！"')]),s._v("\n")])])]),a("p",[s._v("赋予执行权限：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x one_start.sh\n")])])]),a("hr"),s._v(" "),a("h3",{attrs:{id:"_2-配置-webhook-钩子-hooks-json"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-配置-webhook-钩子-hooks-json"}},[s._v("#")]),s._v(" 2. 配置 webhook 钩子 "),a("code",[s._v("hooks.json")])]),s._v(" "),a("p",[s._v("创建配置文件 "),a("code",[s._v("hooks.json")]),s._v("（路径自定，本文以当前目录为例）：")]),s._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"execute-command"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/root/web/project-server/one_start.sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"command-working-directory"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/root/web/project-server"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"response-message"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Script executed"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"include-command-output-in-response"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"capture-output"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"pass-arguments-to-command"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"trigger-rule"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"match"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"value"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"parameter"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"source"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"payload"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password"')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"value"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxx"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),a("hr"),s._v(" "),a("h3",{attrs:{id:"_3-启动-webhook-服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-启动-webhook-服务"}},[s._v("#")]),s._v(" 3. 启动 webhook 服务")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("webhook "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-hooks")]),s._v(" ./hooks.json "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-verbose")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9001")]),s._v("\n")])])]),a("p",[s._v("后台运行建议：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" webhook "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-hooks")]),s._v(" ./hooks.json "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-verbose")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9001")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" webhook.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])])]),a("hr"),s._v(" "),a("h3",{attrs:{id:"_4-测试接口触发部署脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-测试接口触发部署脚本"}},[s._v("#")]),s._v(" 4. 测试接口触发部署脚本")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-X")]),s._v(" POST http://"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("your-server-ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(":9001/hooks/1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/json"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"password": "xxx"}\'')]),s._v("\n")])])]),a("p",[s._v("你会收到脚本执行的完整输出内容，包括 "),a("code",[s._v("git pull")]),s._v("、"),a("code",[s._v("mvn package")]),s._v("、"),a("code",[s._v("docker build")]),s._v("、"),a("code",[s._v("docker run")]),s._v(" 等操作。")]),s._v(" "),a("p",[s._v("此外可以在项目仓库也配置，再相应的事件触发。")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://cdn.qiniu.liyansheng.top/img/image-20250705122000642.png",alt:"image-20250705122000642"}})]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"四、配置第二个-webhook-远程查看-nginx-日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、配置第二个-webhook-远程查看-nginx-日志"}},[s._v("#")]),s._v(" 四、配置第二个 webhook：远程查看 Nginx 日志")]),s._v(" "),a("p",[s._v("有时我们希望在不登录服务器的情况下，远程查看 "),a("code",[s._v("/var/log/nginx/online_access.log")]),s._v(" 日志。我们可以用同样的方式实现。")]),s._v(" "),a("h3",{attrs:{id:"_1-编写查看日志脚本-view-nginx-log-sh"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-编写查看日志脚本-view-nginx-log-sh"}},[s._v("#")]),s._v(" 1. 编写查看日志脚本 "),a("code",[s._v("view_nginx_log.sh")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" /var/log/nginx/online_access.log\n")])])]),a("p",[s._v("赋予执行权限：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x view_nginx_log.sh\n")])])]),a("hr"),s._v(" "),a("h3",{attrs:{id:"_2-添加钩子配置到-hooks-json"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-添加钩子配置到-hooks-json"}},[s._v("#")]),s._v(" 2. 添加钩子配置到 "),a("code",[s._v("hooks.json")])]),s._v(" "),a("p",[s._v("追加如下配置项：")]),s._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"view-nginx-log"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"execute-command"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/root/web/project-server/view_nginx_log.sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"command-working-directory"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/root/web/project-server"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"response-message"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"日志获取完成"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"include-command-output-in-response"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"capture-output"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"pass-arguments-to-command"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"trigger-rule"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"match"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"value"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"parameter"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"source"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"payload"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"value"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxx"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("blockquote",[a("p",[s._v("⚠️ 注意是追加，不要覆盖前一个钩子。")])]),s._v(" "),a("hr"),s._v(" "),a("h3",{attrs:{id:"_3-调用接口查看日志内容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-调用接口查看日志内容"}},[s._v("#")]),s._v(" 3. 调用接口查看日志内容")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-X")]),s._v(" POST http://"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("your-server-ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(":9001/hooks/view-nginx-log "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/json"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"password": "xxx"}\'')]),s._v("\n")])])]),a("p",[s._v("你将看到 Nginx 日志文件的最后 100 行内容。")]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"五、常见问题及排查建议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、常见问题及排查建议"}},[s._v("#")]),s._v(" 五、常见问题及排查建议")]),s._v(" "),a("h3",{attrs:{id:"❓q-为什么请求提示超时"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#❓q-为什么请求提示超时"}},[s._v("#")]),s._v(" ❓Q：为什么请求提示超时？")]),s._v(" "),a("ul",[a("li",[s._v("可能是脚本执行时间过长（比如 Maven 编译、Docker 构建等），建议在客户端增加超时时间；")]),s._v(" "),a("li",[s._v("或者 webhook 执行脚本时遇到权限问题（建议加 "),a("code",[s._v("#!/bin/bash")]),s._v(" 且使用绝对路径）；")]),s._v(" "),a("li",[s._v("可尝试在脚本前后加 "),a("code",[s._v('echo "开始"')]),s._v(" 和 "),a("code",[s._v('echo "结束"')]),s._v("，查看是否卡在中间步骤。")])]),s._v(" "),a("h3",{attrs:{id:"❓q-脚本执行后没响应或失败"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#❓q-脚本执行后没响应或失败"}},[s._v("#")]),s._v(" ❓Q：脚本执行后没响应或失败？")]),s._v(" "),a("ul",[a("li",[s._v("确认 webhook 有权限执行对应的脚本和 Docker；")]),s._v(" "),a("li",[s._v("确认 "),a("code",[s._v("webhook")]),s._v(" 启动时是否加载了 "),a("code",[s._v("hooks.json")]),s._v("；")]),s._v(" "),a("li",[s._v("检查日志输出："),a("code",[s._v("tail -f webhook.log")]),s._v(" 查看报错信息。")])])])}),[],!1,null,null,null);a.default=r.exports}}]);